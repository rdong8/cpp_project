FROM docker.io/fedora:latest

# For now, only install the following with the system package manager:
# - Dependencies of linuxbrew itself (curl, file, procps-ng)
# - gcc-c++ - system toolchain needed for linuxbrew's LLVM
# - fish - need to set user's shell when we create it
# - which - to find fish for the useradd
# - mathjax - dependency of doxygen, but not available via linuxbrew
RUN \
  dnf update -y \
  && dnf install -y \
  @development-tools \
  curl \
  file \
  fish \
  gcc-c++ \
  mathjax \
  procps-ng \
  which \
  && dnf clean all && rm -rf /var/cache/dnf

ARG REMOTE_USER
ARG HOST_UID
ARG HOST_GID
RUN \
  groupadd --gid ${HOST_GID} ${REMOTE_USER} \
  && useradd -ms $(which fish) --uid ${HOST_UID} --gid ${HOST_GID} ${REMOTE_USER}
USER ${REMOTE_USER}

ARG HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew
COPY \
  --from=docker.io/homebrew/brew:latest \
  --chown=${REMOTE_USER} \
  ${HOMEBREW_PREFIX} ${HOMEBREW_PREFIX}

ARG FISH_COMPLETIONS=/home/${REMOTE_USER}/.config/fish/completions
RUN \
  mkdir -p ${FISH_COMPLETIONS} \
  && echo "eval (${HOMEBREW_PREFIX}/bin/brew shellenv)" >> ~/.config/fish/config.fish

RUN \
  eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)" \
  && brew install \
  bat \
  btop \
  cmake \
  doxygen \
  fastfetch \
  fd \
  fzf \
  gawk \
  git-delta \
  helix \
  jq \
  just \
  llvm \
  mold \
  ninja \
  ripgrep \
  tree \
  uv \
  wget \
  zellij

# Fish completions

# just: https://just.systems/man/en/shell-completion-scripts.html
# uv: https://docs.astral.sh/uv/getting-started/installation/#shell-autocompletion
# fzf: https://github.com/junegunn/fzf?tab=readme-ov-file#setting-up-shell-integration
RUN \
  ${HOMEBREW_PREFIX}/bin/just --completions fish > ${FISH_COMPLETIONS}/just.fish \
  && echo 'uv generate-shell-completion fish | source' > ${FISH_COMPLETIONS}/uv.fish \
  && echo 'uvx --generate-shell-completion fish | source' > ${FISH_COMPLETIONS}/uvx.fish \
  && echo 'fzf --fish | source' > ${FISH_COMPLETIONS}/fzf.fish

ENV EDITOR=code
