FROM docker.io/fedora:latest

# For now, only install the following with the system package manager:
# - Compiler-related stuff - have had issues with linuxbrew
# - Dependencies of linuxbrew itself (curl, file, procps-ng)
# - fish - because we have to append `brew shellenv` to the fish config, so the config needs to be created first
# - which - to find fish for the useradd
# - mathjax - dependency of doxygen, but not available via linuxbrew
RUN \
  dnf update -y \
  && dnf install -y \
    @development-tools \
    curl \
    clang \
    clang-tools-extra-devel \
    compiler-rt \
    file \
    fish \
    libcxx-devel \
    lldb \
    llvm \
    mathjax \
    procps-ng \
    which \
  && dnf clean all && rm -rf /var/cache/dnf

ARG USERNAME=dev
RUN useradd -ms $(which fish) $USERNAME

# Install brew (generally more up to date than dnf)
ARG HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew
RUN \
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" \
  && sudo chown -R $USERNAME $HOMEBREW_PREFIX \
  && chmod u+w $HOMEBREW_PREFIX

USER $USERNAME

ARG FISH_COMPLETIONS=/home/${USERNAME}/.config/fish/completions
RUN \
  mkdir -p $FISH_COMPLETIONS \
  && echo "eval (${HOMEBREW_PREFIX}/bin/brew shellenv)" >> ~/.config/fish/config.fish

RUN \
  eval $(${HOMEBREW_PREFIX}/bin/brew shellenv) \
  && brew install \
    bat \
    btop \
    cmake \
    doxygen \
    fastfetch \
    fd \
    fzf \
    gawk \
    git-delta \
    helix \
    jq \
    just \
    mold \
    ninja \
    ripgrep \
    tree \
    uv \
    wget \
    zellij

# Fish completions

# just: https://just.systems/man/en/shell-completion-scripts.html
# uv: https://docs.astral.sh/uv/getting-started/installation/#shell-autocompletion
# fzf: https://github.com/junegunn/fzf?tab=readme-ov-file#setting-up-shell-integration
RUN \
  ${HOMEBREW_PREFIX}/bin/just --completions fish > ${FISH_COMPLETIONS}/just.fish \
  && echo 'uv generate-shell-completion fish | source' > ${FISH_COMPLETIONS}/uv.fish \
  && echo 'uvx --generate-shell-completion fish | source' > ${FISH_COMPLETIONS}/uvx.fish \
  && echo 'fzf --fish | source' > ${FISH_COMPLETIONS}/fzf.fish

ENV EDITOR=code
