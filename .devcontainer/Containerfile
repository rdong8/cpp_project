FROM docker.io/fedora:latest

# For now, only install the following with the system package manager:
# - Dependencies of linuxbrew itself (curl, file, procps-ng)
# - gcc-c++ - system toolchain needed for linuxbrew's LLVM
# - fish - need to set user's shell when we create it
# - which - to find fish for the useradd
# - mathjax - dependency of doxygen, but not available via linuxbrew
RUN \
  dnf update -y \
  && dnf install -y \
  @development-tools \
  curl \
  file \
  fish \
  gcc-c++ \
  mathjax \
  procps-ng \
  which \
  && dnf clean all && rm -rf /var/cache/dnf

ARG REMOTE_USER
ARG HOST_UID
ARG HOST_GID
RUN \
  groupadd --gid ${HOST_GID} ${REMOTE_USER} \
  && useradd -ms $(which fish) --uid ${HOST_UID} --gid ${HOST_GID} ${REMOTE_USER}
USER ${REMOTE_USER}

ARG HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew
COPY \
  --from=docker.io/homebrew/brew:latest \
  --chown=${REMOTE_USER} \
  ${HOMEBREW_PREFIX} ${HOMEBREW_PREFIX}

RUN \
  echo "eval (${HOMEBREW_PREFIX}/bin/brew shellenv)" >> ~/.config/fish/config.fish \
  && eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)" \
  && brew install \
  bat \
  btop \
  cmake \
  conan \
  doxygen \
  fastfetch \
  fd \
  fzf \
  gawk \
  git-delta \
  helix \
  jq \
  just \
  mold \
  ninja \
  prek \
  ripgrep \
  tree \
  uv \
  wget \
  zellij

# NOTE: to install LLVM from head, you can add remove llvm from the list above and add this
# TODO: exit 0 is there because the postinstall fails for some reason
# You have to run `brew postinstall llvm` manually in the devcontainer
# RUN \
#   eval "$(${HOMEBREW_PREFIX}/bin/brew shellenv)" \
#   && brew install llvm --HEAD -vd \
#   ; exit 0

# Fish completions
# Only necessary if not builtin: https://github.com/fish-shell/fish-shell/tree/master/share/completions
# prek: https://prek.j178.dev/installation/#shell-completion
ARG FISH_COMPLETIONS=/home/${REMOTE_USER}/.config/fish/completions
RUN \
  mkdir -p ${FISH_COMPLETIONS} && \
  COMPLETE=fish prek > ${FISH_COMPLETIONS}/prek.fish
